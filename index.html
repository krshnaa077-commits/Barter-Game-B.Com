<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üè∫ Crisis Bazaar</title>
    <style>
        :root { 
            --gold: #ffd700; 
            --bg: #0a0e27; 
            --card: #1a1f3a; 
            --red: #ff6b6b; 
            --blue: #4ecdc4;
            --green: #95e1d3;
            --purple: #a78bfa;
        }
        
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', 'Arial', sans-serif; 
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1419 100%);
            color: #e8eaf6; 
            margin: 0; 
            padding: 12px; 
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .app-container { 
            width: 100%; 
            max-width: 480px; 
            background: rgba(26, 31, 58, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px; 
            display: flex; 
            flex-direction: column; 
            max-height: 96vh; 
            overflow: hidden; 
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
                        0 0 40px rgba(255, 215, 0, 0.1);
        }
        
        header { 
            padding: 20px; 
            text-align: center; 
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(78, 205, 196, 0.2) 100%);
            border-bottom: 3px solid var(--gold);
        }
        
        header h2 {
            margin: 0;
            color: var(--gold);
            font-size: 1.8rem;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.5);
            letter-spacing: 2px;
        }
        
        .screen { 
            padding: 20px; 
            flex: 1; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
        }
        
        .hidden { display: none !important; }

        /* Crisis UI */
        .crisis-box { 
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            color: #1a1f3a; 
            padding: 18px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
            border-left: 8px solid var(--red);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
        }
        
        .crisis-title { 
            font-weight: 700; 
            font-size: 1.3rem; 
            display: flex; 
            align-items: center; 
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .crisis-goal {
            font-size: 0.95rem;
            padding: 8px 12px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 8px;
            border: 2px solid var(--red);
        }

        /* Inventory Grid - Optimized for Emojis */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            margin: 15px 0; 
        }
        
        .card { 
            background: linear-gradient(135deg, #2d3561 0%, #1f2544 100%);
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px; 
            padding: 18px 8px; 
            text-align: center; 
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .card:hover {
            transform: translateY(-4px);
            border-color: rgba(255, 215, 0, 0.5);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.2);
        }
        
        .card.selected { 
            border-color: var(--gold);
            background: linear-gradient(135deg, #4a5283 0%, #2d3561 100%);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }
        
        .card.selected::before {
            content: '‚úì';
            position: absolute;
            top: 6px;
            right: 6px;
            background: var(--gold);
            color: #1a1f3a;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.5);
        }
        
        .emoji { 
            font-size: 3rem; 
            display: block; 
            margin-bottom: 8px;
            line-height: 1;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        .label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #b8c5d6;
        }

        /* Join Screen */
        .join-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 15px;
        }
        
        .welcome-icon {
            font-size: 5rem;
            text-align: center;
            margin-bottom: 10px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        .welcome-text {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 20px;
            color: #b8c5d6;
        }

        /* History Tab */
        .history-list { 
            font-size: 0.8rem; 
            background: rgba(0, 0, 0, 0.3);
            padding: 12px; 
            border-radius: 10px; 
            max-height: 120px; 
            overflow-y: auto; 
            margin-top: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-entry { 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 0; 
            display: flex; 
            justify-content: space-between;
            align-items: center;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-entry small {
            color: var(--gold);
            font-weight: 600;
        }

        /* Buttons */
        button { 
            padding: 15px; 
            border-radius: 12px; 
            border: none; 
            font-weight: 700; 
            cursor: pointer; 
            margin-top: 8px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        
        button:active {
            transform: scale(0.97);
        }
        
        .btn-main { 
            background: linear-gradient(135deg, var(--gold) 0%, #ffed4e 100%);
            color: #1a1f3a;
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }
        
        .btn-main:hover {
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
            transform: translateY(-2px);
        }
        
        .btn-trade { 
            background: linear-gradient(135deg, var(--blue) 0%, #38d39f 100%);
            color: white; 
            width: 100%;
            box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
        }
        
        .btn-trade:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.6);
            transform: translateY(-2px);
        }
        
        .btn-trade:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .btn-nav { 
            background: rgba(255, 255, 255, 0.1);
            color: white; 
            font-size: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-nav:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--red) 0%, #ee5a6f 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }
        
        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
            transform: translateY(-2px);
        }
        
        /* Select Dropdown */
        select {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 8px;
        }
        
        select option {
            background: #1a1f3a;
            color: white;
        }

        /* Win Overlay */
        #win-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            text-align: center;
            justify-content: center;
            padding: 30px;
        }
        
        .win-icon {
            font-size: 6rem;
            margin-bottom: 20px;
            animation: bounce 1s ease infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-25px); }
        }
        
        #win-overlay h1 {
            color: var(--gold);
            font-size: 2.5rem;
            margin-bottom: 15px;
            text-shadow: 0 4px 20px rgba(255, 215, 0, 0.5);
        }
        
        #win-msg {
            font-size: 1.3rem;
            margin-bottom: 30px;
            color: #b8c5d6;
        }

        /* Dashboard */
        .dash-card {
            background: rgba(255, 255, 255, 0.05);
            margin: 10px 0;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid var(--gold);
        }
        
        .dash-card b {
            color: var(--gold);
            display: block;
            margin-bottom: 8px;
        }
        
        .dash-emojis {
            font-size: 1.5rem;
            line-height: 1.5;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        ::-webkit-scrollbar-thumb { 
            background: rgba(255, 215, 0, 0.3); 
            border-radius: 3px; 
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: rgba(255, 215, 0, 0.5); 
        }
    </style>
</head>
<body>

<div id="win-overlay" class="screen hidden">
    <div class="win-icon">üèÜ</div>
    <h1>MISSION SUCCESS</h1>
    <p id="win-msg"></p>
    <button class="btn-main" onclick="location.reload()">Back to Menu</button>
</div>

<div class="app-container">
    <header>
        <h2>üè∫ CRISIS BAZAAR</h2>
    </header>

    <div id="join-screen" class="screen">
        <div class="join-content">
            <div class="welcome-icon">üè™</div>
            <div class="welcome-text">
                Choose your stall and help survive the crisis
            </div>
            <select id="pick-stall">
                <option value="1">üè™ Merchant Stall 1</option>
                <option value="2">üè™ Merchant Stall 2</option>
                <option value="3">üè™ Merchant Stall 3</option>
                <option value="4">üè™ Merchant Stall 4</option>
                <option value="5">üè™ Merchant Stall 5</option>
            </select>
            <button class="btn-main" onclick="enterGame()">‚ö° Enter Market</button>
            <button class="btn-nav" onclick="enterDashboard()">üìä View Dashboard</button>
        </div>
    </div>

    <div id="game-screen" class="screen hidden">
        <div id="crisis-display" class="crisis-box"></div>
        <div id="inventory" class="grid"></div>
        <div style="margin-top:auto;">
            <select id="target-stall"></select>
            <button id="trade-btn" class="btn-trade" onclick="doTrade()" disabled>ü§ù Send Selected Cards</button>
            <div class="history-list" id="history-log"></div>
            <button class="btn-nav" style="width:100%;" onclick="location.reload()">‚Üê Exit to Menu</button>
        </div>
    </div>

    <div id="dash-screen" class="screen hidden">
        <h3 style="color: var(--gold); text-align: center; margin-bottom: 20px;">üìä Live Market Data</h3>
        <div id="dash-list"></div>
        <button class="btn-danger" onclick="resetAll()">üîÑ Full Reset</button>
        <button class="btn-nav" onclick="location.reload()">‚Üê Close Dashboard</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCw38ORY-168_FWy-Vclfzwxx5RhEVayOM",
        authDomain: "div-a-bartergame.firebaseapp.com",
        databaseURL: "https://div-a-bartergame-default-rtdb.firebaseio.com",
        projectId: "div-a-bartergame",
        storageBucket: "div-a-bartergame.firebasestorage.app",
        messagingSenderId: "463648583120",
        appId: "1:463648583120:web:35e16b08c557b44a781dd5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const RES = [{n:'Rice', e:'üçö'}, {n:'Cattle', e:'üêÑ'}, {n:'Wood', e:'ü™µ'}, {n:'Tools', e:'üîß'}, {n:'Shelter', e:'üè†'}];
    const CRISES = [
        { name: "Flood", goal: "Cattle", icon: "üåä", msg: "Rescue livestock!" },
        { name: "Plague", goal: "Shelter", icon: "ü¶†", msg: "Build quarantine!" },
        { name: "Drought", goal: "Rice", icon: "‚òÄÔ∏è", msg: "Save food!" },
        { name: "War", goal: "Tools", icon: "‚öîÔ∏è", msg: "Forge defenses!" },
        { name: "Heavy Snow", goal: "Wood", icon: "‚ùÑÔ∏è", msg: "Provide heat!" }
    ];

    let myStall = localStorage.getItem('stall_v10');
    let isDash = localStorage.getItem('mode_v10') === 'dash';
    window.selectedCards = new Set();

    onValue(ref(db, 'bazaar'), (snap) => {
        const state = snap.val();
        if(!state) return;
        if(isDash) renderDash(state);
        else if(myStall) renderGame(state);
    });

    window.enterGame = () => {
        myStall = document.getElementById('pick-stall').value;
        localStorage.setItem('stall_v10', myStall);
        localStorage.setItem('mode_v10', 'game');
        location.reload();
    };

    window.enterDashboard = () => {
        localStorage.setItem('mode_v10', 'dash');
        isDash = true;
        location.reload();
    };

    function renderGame(state) {
        document.getElementById('join-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        const team = state.teams[myStall];
        const inv = document.getElementById('inventory');
        inv.innerHTML = '';
        
        document.getElementById('crisis-display').innerHTML = `
            <div class="crisis-title">${team.crisis.icon} ${team.crisis.name}</div>
            <div class="crisis-goal">üéØ Goal: Collect <b>4 ${team.crisis.goal}</b> to survive!</div>
        `;

        let counts = {};
        (team.cards || []).forEach(c => {
            counts[c.type] = (counts[c.type] || 0) + 1;
            const div = document.createElement('div');
            div.className = `card ${window.selectedCards.has(c.id) ? 'selected' : ''}`;
            div.onclick = () => {
                window.selectedCards.has(c.id) ? window.selectedCards.delete(c.id) : window.selectedCards.add(c.id);
                renderGame(state);
            };
            div.innerHTML = `<span class="emoji">${c.emoji}</span><span class="label">${c.type}</span>`;
            inv.appendChild(div);
        });

        document.getElementById('history-log').innerHTML = (team.history || []).map(h => `<div class="log-entry"><span>${h.txt}</span><small>${h.time}</small></div>`).join('') || '<div style="text-align:center; opacity:0.5;">No trades yet</div>';
        document.getElementById('trade-btn').disabled = !window.selectedCards.size;
        
        let tHtml = '<option value="">Select Trading Partner...</option>';
        for(let i=1; i<=5; i++) if(i != myStall) tHtml += `<option value="${i}">Stall ${i}</option>`;
        document.getElementById('target-stall').innerHTML = tHtml;

        if(counts[team.crisis.goal] >= 4) {
            document.getElementById('win-overlay').classList.remove('hidden');
            document.getElementById('win-msg').innerText = `You successfully survived the ${team.crisis.name} crisis! üéâ`;
        }
    }

    window.doTrade = async () => {
        const target = document.getElementById('target-stall').value;
        if(!target) return alert("Please select a trading partner!");
        
        const snap = await get(ref(db, 'bazaar'));
        const state = snap.val();
        const toSend = state.teams[myStall].cards.filter(c => window.selectedCards.has(c.id));
        const toKeep = state.teams[myStall].cards.filter(c => !window.selectedCards.has(c.id));
        const now = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        const up = {};
        up[`bazaar/teams/${myStall}/cards`] = toKeep;
        up[`bazaar/teams/${myStall}/history`] = [{txt: `‚Üí Sent ${toSend.length} to Stall ${target}`, time: now}, ...(state.teams[myStall].history || [])].slice(0, 10);
        up[`bazaar/teams/${target}/cards`] = [...(state.teams[target].cards || []), ...toSend];
        up[`bazaar/teams/${target}/history`] = [{txt: `‚Üê Got ${toSend.length} from Stall ${myStall}`, time: now}, ...(state.teams[target].history || [])].slice(0, 10);
        
        await update(ref(db), up);
        window.selectedCards.clear();
    };

    function renderDash(state) {
        document.getElementById('join-screen').classList.add('hidden');
        document.getElementById('dash-screen').classList.remove('hidden');
        document.getElementById('dash-list').innerHTML = Object.entries(state.teams).map(([id, t]) => `
            <div class="dash-card">
                <b>Stall ${id} - ${t.crisis.icon} ${t.crisis.name}</b>
                <div class="dash-emojis">${t.cards.map(c=>c.emoji).join(' ')}</div>
            </div>
        `).join('');
    }

    window.resetAll = async () => {
        if(!confirm("‚ö†Ô∏è This will reset all teams and redistribute resources. Continue?")) return;
        
        const shuffledCrises = [...CRISES].sort(() => Math.random() - 0.5);
        let teams = {};
        for(let t=1; t<=5; t++) {
            let cards = [];
            let counts = { Rice:0, Cattle:0, Wood:0, Tools:0, Shelter:0 };
            while(cards.length < 10) {
                let r = RES[Math.floor(Math.random()*RES.length)];
                // Rule: No card more than 3 per team at start
                if(counts[r.n] < 3) {
                    // Rule: Make condition card scarce
                    if(r.n === shuffledCrises[t-1].goal && Math.random() > 0.2) continue; 
                    counts[r.n]++;
                    cards.push({ id: Math.random().toString(36).substr(2,7), type: r.n, emoji: r.e });
                }
            }
            teams[t] = { cards, crisis: shuffledCrises[t-1], history: [] };
        }
        await set(ref(db, 'bazaar'), { teams });
        location.reload();
    };
</script>
</body>
</html>
