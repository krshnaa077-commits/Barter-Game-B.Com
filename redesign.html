<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barter System: Professional Edition</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg: #f8fafc;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --accent: #ec4899;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1e293b;
            min-height: 100vh;
            padding: 10px;
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            max-width: 900px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            margin: auto;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 15px;
        }

        h1 { margin: 0; font-size: 1.5rem; color: #4338ca; }
        .team-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 800;
            margin-top: 8px;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4);
        }

        /* Layout Grid */
        .game-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .game-grid { grid-template-columns: 1.2fr 0.8fr; }
        }

        section {
            background: white;
            border-radius: 15px;
            padding: 15px;
            border: 1px solid #f1f5f9;
            box-shadow: var(--card-shadow);
        }

        h2 { font-size: 1.1rem; margin-top: 0; display: flex; align-items: center; gap: 8px; }

        /* Card Styling */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 5px;
        }

        .card {
            background: #fff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            position: relative;
        }

        .card.selected {
            border-color: var(--primary);
            background: #eef2ff;
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3);
        }

        .card.selected::after {
            content: '‚úì';
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--primary);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            line-height: 20px;
        }

        .card-emoji { font-size: 1.8rem; display: block; margin-bottom: 4px; }
        .card-label { font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; }

        /* Trade Controls */
        .trade-box { display: flex; flex-direction: column; gap: 15px; }
        
        select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            font-size: 1rem;
            outline: none;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            font-size: 1rem;
        }

        .btn:disabled { background: #cbd5e1; cursor: not-allowed; }
        .btn:active { transform: scale(0.98); }

        /* History */
        .history-list {
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.85rem;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .type-sent { color: #ef4444; font-weight: 600; }
        .type-rcvd { color: #22c55e; font-weight: 600; }

        /* Utility */
        .hidden { display: none; }
        .selection-counter {
            font-size: 0.8rem;
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<div class="app-container">
    <div id="view-join" class="view">
        <header>
            <h1>ü§ù Barter Simulator</h1>
            <p>5 Teams ‚Ä¢ 50 Unique Cards ‚Ä¢ Live Trading</p>
        </header>
        <div style="text-align: center; padding: 40px 0;">
            <button class="btn" style="width: 200px;" onclick="joinGame()">Enter Game</button>
            <p id="join-error" style="color: #ef4444; margin-top: 15px; font-weight: 600;"></p>
            <div style="margin-top: 40px;">
                <button onclick="resetGlobalState()" style="background:none; border:none; color:#94a3b8; text-decoration:underline; cursor:pointer; font-size:0.8rem;">Reset Entire Session</button>
            </div>
        </div>
    </div>

    <div id="view-main" class="view hidden">
        <header>
            <h1>ü§ù Barter System</h1>
            <div id="my-team-badge" class="team-badge">Team ?</div>
        </header>

        <div class="game-grid">
            <section>
                <h2>üéí Your Inventory</h2>
                <div id="select-count" class="selection-counter">Selected: 0 cards</div>
                <div id="inventory-container" class="inventory-grid">
                    </div>
            </section>

            <div class="trade-box">
                <section>
                    <h2>üì§ Send Resources</h2>
                    <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 10px;">Select cards from your inventory, choose a recipient, and send.</p>
                    <div class="trade-box">
                        <select id="recipient-select">
                            <option value="">Select Recipient Team...</option>
                            <option value="1">Team 1</option>
                            <option value="2">Team 2</option>
                            <option value="3">Team 3</option>
                            <option value="4">Team 4</option>
                            <option value="5">Team 5</option>
                        </select>
                        <button id="send-btn" class="btn" onclick="executeTransfer()">Transfer Selected Cards</button>
                        <p id="action-msg" style="font-size: 0.8rem; text-align: center; min-height: 1em;"></p>
                    </div>
                </section>

                <section>
                    <h2>üìú Private History</h2>
                    <div id="history-container" class="history-list">
                        </div>
                </section>
            </div>
        </div>
    </div>
</div>

<script>
    /**
     * GAME CONFIGURATION
     */
    const CONFIG = {
        STORAGE_KEY: 'BARTER_OFFLINE_STATE',
        TEAMS: [1, 2, 3, 4, 5],
        RESOURCES: [
            { type: 'Rice', emoji: 'üçö' },
            { type: 'Animals', emoji: 'üêÑ' },
            { type: 'Food', emoji: 'üçé' },
            { type: 'Tools', emoji: 'üîß' },
            { type: 'Shelter', emoji: 'üè†' }
        ]
    };

    let myTeamId = null;
    let selectedCards = new Set();

    /**
     * ENGINE: STATE MANAGEMENT
     */
    function getState() {
        const data = localStorage.getItem(CONFIG.STORAGE_KEY);
        return data ? JSON.parse(data) : null;
    }

    function saveState(state) {
        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(state));
        // Manually dispatch storage event for the same window to trigger UI updates
        window.dispatchEvent(new Event('storage'));
    }

    function initGlobalState() {
        if (getState()) return;

        // 1. Create Master Deck (50 Cards)
        const deck = [];
        CONFIG.RESOURCES.forEach(res => {
            for (let i = 1; i <= 10; i++) {
                deck.push({
                    id: `${res.type.charAt(0)}${i}-${Math.random().toString(36).substr(2, 5)}`,
                    type: res.type,
                    emoji: res.emoji
                });
            }
        });

        // 2. Strict Initial Distribution
        // Shuffle until every team has <= 3 of any single resource
        let distributionValid = false;
        let teams = {};

        while (!distributionValid) {
            const tempDeck = [...deck].sort(() => Math.random() - 0.5);
            teams = { 1: [], 2: [], 3: [], 4: [], 5: [] };
            distributionValid = true;

            for (let t = 1; t <= 5; t++) {
                const teamCards = tempDeck.splice(0, 10);
                teams[t] = teamCards;

                // Validation
                const counts = {};
                teamCards.forEach(c => counts[c.type] = (counts[c.type] || 0) + 1);
                if (Object.values(counts).some(count => count >= 4)) {
                    distributionValid = false;
                    break;
                }
            }
        }

        const initialState = {
            teams: teams,
            history: [],
            activeTeams: []
        };
        saveState(initialState);
    }

    /**
     * CORE ACTIONS
     */
    function joinGame() {
        initGlobalState();
        const state = getState();
        const sessionTeam = sessionStorage.getItem('TEAM_LOCK');

        if (sessionTeam) {
            myTeamId = parseInt(sessionTeam);
        } else {
            // Assign next free slot
            for (let t of CONFIG.TEAMS) {
                if (!state.activeTeams.includes(t)) {
                    myTeamId = t;
                    state.activeTeams.push(t);
                    sessionStorage.setItem('TEAM_LOCK', t);
                    saveState(state);
                    break;
                }
            }
        }

        if (myTeamId) {
            document.getElementById('view-join').classList.add('hidden');
            document.getElementById('view-main').classList.remove('hidden');
            document.getElementById('my-team-badge').innerText = `Team ${myTeamId}`;
            
            // Clean recipient select (can't send to self)
            const sel = document.getElementById('recipient-select');
            Array.from(sel.options).forEach(opt => {
                if (parseInt(opt.value) === myTeamId) opt.remove();
            });

            renderUI();
        } else {
            document.getElementById('join-error').innerText = "Game is Full! (5 Teams already joined)";
        }
    }

    function toggleCard(cardId) {
        if (selectedCards.has(cardId)) {
            selectedCards.delete(cardId);
        } else {
            selectedCards.add(cardId);
        }
        renderUI();
    }

    function executeTransfer() {
        const recipientId = parseInt(document.getElementById('recipient-select').value);
        const msg = document.getElementById('action-msg');

        if (!recipientId) {
            notify("Select a recipient team!", "red");
            return;
        }
        if (selectedCards.size === 0) {
            notify("Select at least one card to send!", "red");
            return;
        }

        const state = getState();
        const myInventory = state.teams[myTeamId];
        const targetInventory = state.teams[recipientId];

        // Identify cards to move
        const cardsToMove = myInventory.filter(c => selectedCards.has(c.id));
        const cardsToKeep = myInventory.filter(c => !selectedCards.has(c.id));

        // Update State
        state.teams[myTeamId] = cardsToKeep;
        state.teams[recipientId] = [...targetInventory, ...cardsToMove];

        // Record History
        state.history.push({
            from: myTeamId,
            to: recipientId,
            cards: cardsToMove,
            timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        });

        saveState(state);
        selectedCards.clear();
        notify(`Sent ${cardsToMove.length} cards to Team ${recipientId}`, "green");
        renderUI();
    }

    /**
     * UI RENDERING
     */
    function renderUI() {
        const state = getState();
        if (!state || !myTeamId) return;

        // 1. Render Inventory
        const container = document.getElementById('inventory-container');
        container.innerHTML = '';
        const myCards = state.teams[myTeamId];

        myCards.forEach(card => {
            const isSelected = selectedCards.has(card.id);
            const el = document.createElement('div');
            el.className = `card ${isSelected ? 'selected' : ''}`;
            el.onclick = () => toggleCard(card.id);
            el.innerHTML = `
                <span class="card-emoji">${card.emoji}</span>
                <span class="card-label">${card.type}</span>
            `;
            container.appendChild(el);
        });

        document.getElementById('select-count').innerText = `Selected: ${selectedCards.size} cards`;

        // 2. Render History
        const histContainer = document.getElementById('history-container');
        histContainer.innerHTML = '';
        
        // Only show history relevant to this team
        const relevantHistory = state.history.filter(h => h.from === myTeamId || h.to === myTeamId).reverse();

        relevantHistory.forEach(entry => {
            const isSender = entry.from === myTeamId;
            const div = document.createElement('div');
            div.className = 'history-item';
            
            const cardIcons = entry.cards.map(c => c.emoji).join('');
            
            div.innerHTML = `
                <div>
                    <span class="${isSender ? 'type-sent' : 'type-rcvd'}">
                        ${isSender ? 'OUT' : 'IN'}
                    </span>
                    <span style="margin-left:8px">${isSender ? 'To T'+entry.to : 'From T'+entry.from}</span>
                    <div style="font-size: 1.2rem; margin-top:4px">${cardIcons}</div>
                </div>
                <div style="color:#94a3b8; font-size: 0.7rem;">${entry.timestamp}</div>
            `;
            histContainer.appendChild(div);
        });
    }

    function notify(text, color) {
        const msg = document.getElementById('action-msg');
        msg.innerText = text;
        msg.style.color = color === 'red' ? '#ef4444' : '#22c55e';
        setTimeout(() => msg.innerText = "", 3000);
    }

    function resetGlobalState() {
        if (confirm("THIS WILL DELETE THE ENTIRE CLASSROOM GAME DATA. Proceed?")) {
            localStorage.removeItem(CONFIG.STORAGE_KEY);
            sessionStorage.removeItem('TEAM_LOCK');
            location.reload();
        }
    }

    // Auto-update UI if state changes in another tab
    window.addEventListener('storage', () => {
        renderUI();
    });

    // Handle mobile refresh simulation
    setInterval(() => {
        if (myTeamId) renderUI();
    }, 3000);

</script>
</body>
</html>